<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>[译] 深入理解 Python 字典实现过程 | 猫尾 と 香辛料 🐾</title>
    <meta name="description" content="樱桃炸弹・蓝莓特攻">
    <link rel="icon" href="/logo.png">
  <meta name="theme-color" content="#3eaf7c">
    
    <link rel="preload" href="/assets/css/0.styles.405a0bce.css" as="style"><link rel="preload" href="/assets/js/app.2e0dc0ff.js" as="script"><link rel="preload" href="/assets/js/1.b11822ca.js" as="script"><link rel="preload" href="/assets/js/21.93fd3aea.js" as="script"><link rel="prefetch" href="/assets/js/10.933a8899.js"><link rel="prefetch" href="/assets/js/11.24f97485.js"><link rel="prefetch" href="/assets/js/12.975b4b58.js"><link rel="prefetch" href="/assets/js/13.9688e801.js"><link rel="prefetch" href="/assets/js/14.d6d3bd38.js"><link rel="prefetch" href="/assets/js/15.18ec2192.js"><link rel="prefetch" href="/assets/js/16.28c73d03.js"><link rel="prefetch" href="/assets/js/17.54e6fe7d.js"><link rel="prefetch" href="/assets/js/18.d4804358.js"><link rel="prefetch" href="/assets/js/19.0b0e603f.js"><link rel="prefetch" href="/assets/js/20.16a075d9.js"><link rel="prefetch" href="/assets/js/22.e22428d6.js"><link rel="prefetch" href="/assets/js/23.329f97c7.js"><link rel="prefetch" href="/assets/js/24.d35000a7.js"><link rel="prefetch" href="/assets/js/3.cb227d5c.js"><link rel="prefetch" href="/assets/js/4.62b10f31.js"><link rel="prefetch" href="/assets/js/5.eedad0e8.js"><link rel="prefetch" href="/assets/js/6.9430a925.js"><link rel="prefetch" href="/assets/js/7.ec5b1774.js"><link rel="prefetch" href="/assets/js/8.be5e6e68.js"><link rel="prefetch" href="/assets/js/9.21ce5146.js">
    <link rel="stylesheet" href="/assets/css/0.styles.405a0bce.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">猫尾 と 香辛料 🐾</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/post/" class="nav-link router-link-active">归档</a></div><div class="nav-item"><a href="/tag/" class="nav-link">标签</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/post/" class="nav-link router-link-active">归档</a></div><div class="nav-item"><a href="/tag/" class="nav-link">标签</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>[译] 深入理解 Python 字典实现过程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/post/python-dictionary-implementation/#pydictobject-结构体" class="sidebar-link">PyDictObject 结构体</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/post/python-dictionary-implementation/#ma-fill" class="sidebar-link">ma_fill</a></li><li class="sidebar-sub-header"><a href="/post/python-dictionary-implementation/#ma-used" class="sidebar-link">ma_used</a></li><li class="sidebar-sub-header"><a href="/post/python-dictionary-implementation/#ma-mask" class="sidebar-link">ma_mask</a></li><li class="sidebar-sub-header"><a href="/post/python-dictionary-implementation/#ma-table" class="sidebar-link">ma_table</a></li><li class="sidebar-sub-header"><a href="/post/python-dictionary-implementation/#ma-lookup" class="sidebar-link">ma_lookup</a></li><li class="sidebar-sub-header"><a href="/post/python-dictionary-implementation/#ma-smalltable" class="sidebar-link">ma_smalltable</a></li></ul></li><li><a href="/post/python-dictionary-implementation/#碰撞" class="sidebar-link">碰撞</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/python-dictionary-implementation/#哈希表大小" class="sidebar-link">哈希表大小</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/python-dictionary-implementation/#空闲列表" class="sidebar-link">空闲列表</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/python-dictionary-implementation/#键共享与有序字典" class="sidebar-link">键共享与有序字典</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/python-dictionary-implementation/#我的想法" class="sidebar-link">我的想法</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"><div slot="top" class="content head"><h1 id="[译] 深入理解 Python 字典实现过程">
        [译] 深入理解 Python 字典实现过程
      </h1> <div class="tag-links">
  tags:
  <a href="/tag/#翻译" class="tag">
    翻译
  </a><a href="/tag/#Python" class="tag">
    Python
  </a></div></div> <div class="content default"><blockquote><ul><li>原文地址：<a href="https://fengsp.github.io/blog/2017/3/python-dictionary/" target="_blank" rel="noopener noreferrer">Python dictionary, the implementation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>原文作者：<a href="https://twitter.com/_fengsp" target="_blank" rel="noopener noreferrer">Shipeng Feng<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>译文出自：<a href="https://blog.zthxxx.me/post/python-dictionary-implementation/" target="_blank" rel="noopener noreferrer">zthxxx's blog<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>译者：<a href="https://github.com/zthxxx" target="_blank" rel="noopener noreferrer">zthxxx<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>校对者：<a href="https://github.com/Zheaoli" target="_blank" rel="noopener noreferrer">Zheaoli<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>注：原文与本译文均基于 <strong>CC BY-NC-SA</strong> 发布</li></ul></blockquote> <p>字典是一种内置于 Python 中非常有用的数据类型，总的来说它是一些由键（key）索引的对象，这里的 key 是必须是不可变的。 以下是一个简单的字典用法示例：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'fengsp'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'amy'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">}</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d<span class="token punctuation">[</span><span class="token string">'fengsp'</span><span class="token punctuation">]</span>
<span class="token number">10</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">del</span> d<span class="token punctuation">[</span><span class="token string">'fengsp'</span><span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> d<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token string">'amy'</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>通常我们会多次的检索一个值（value），因此通过 key 来检索一个对象的过程必须是个非常快速的操作。对于 CPython 本身，多种语法特性都是在字典的帮助下支持的，例如，类实例就是使用字典来储存实例属性，可见字典的性能至关重要。</p> <h2 id="pydictobject-结构体"><a href="#pydictobject-结构体" aria-hidden="true" class="header-anchor">#</a> PyDictObject 结构体</h2> <p>在 CPython 源码中，字典是一个 C 的结构体， <code>PyDictObject</code>：</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">PyDictObject</span> <span class="token punctuation">{</span>
    PyObject_HEAD
    Py_ssize_t ma_fill<span class="token punctuation">;</span>  <span class="token comment">/* # Active + # Dummy */</span>
    Py_ssize_t ma_used<span class="token punctuation">;</span>  <span class="token comment">/* # Active */</span>
    Py_ssize_t ma_mask<span class="token punctuation">;</span>

    PyDictEntry <span class="token operator">*</span>ma_table<span class="token punctuation">;</span>
    PyDictEntry <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>ma_lookup<span class="token punctuation">)</span><span class="token punctuation">(</span>PyDictObject <span class="token operator">*</span>mp<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">long</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
    PyDictEntry ma_smalltable<span class="token punctuation">[</span>PyDict_MINSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Py_ssize_t me_hash<span class="token punctuation">;</span>
    PyObject <span class="token operator">*</span>me_key<span class="token punctuation">;</span>
    PyObject <span class="token operator">*</span>me_value<span class="token punctuation">;</span>
<span class="token punctuation">}</span> PyDictEntry<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>在此数据结构中的这些字段分别是：</p> <h3 id="ma-fill"><a href="#ma-fill" aria-hidden="true" class="header-anchor">#</a> <strong>ma_fill</strong></h3> <p>表示所有激活元素（active entry）和虚拟元素（dummy entry）的计数。
如果删除一个 key，这个元素将成为虚拟元素，并且 <code>ma_fill</code> 任然保持不变；如果添加一个新的 key 并且新 key 不属于虚拟元素，则 <code>ma_fill</code> 增加 1。</p> <h3 id="ma-used"><a href="#ma-used" aria-hidden="true" class="header-anchor">#</a> <strong>ma_used</strong></h3> <p>对象中所有激活元素的计数。如果添加一个新 key，<code>ma_used</code> 会增加 1，如果删除一个 key，这个字段将减 1。</p> <h3 id="ma-mask"><a href="#ma-mask" aria-hidden="true" class="header-anchor">#</a> <strong>ma_mask</strong></h3> <p>哈希表的位掩码，这个表中包含 <code>ma_mask + 1</code> 个哈希槽(slot)。
这里储存位掩码而不是大小，因为在查找元素的一个 key 时，使用 <code>slot = key_hash &amp; mask</code> 就能直接获得哈希槽序号。</p> <h3 id="ma-table"><a href="#ma-table" aria-hidden="true" class="header-anchor">#</a> <strong>ma_table</strong></h3> <p>一个 <code>PyDictEntry</code> 结构体的数组， <code>PyDictEntry</code> 包含 key 对象、value 对象，以及 key 的哈希；
这些 key 的哈希作为缓存储存起来，例如，当我们搜索一个 key 时，我们可以通过使用缓存哈希来执行快速比较查找。</p> <h3 id="ma-lookup"><a href="#ma-lookup" aria-hidden="true" class="header-anchor">#</a> <strong>ma_lookup</strong></h3> <p>一个用于查找 key 的函数指针。初始化时它被设置为 <code>lookdict_string</code>。
<code>lookdict_string</code> 假定字典的 key 全是 <code>PyStringObject</code> 类型，这是一个使得查找 <code>StringDictObject</code> 类型的 key 可以快很多的最佳优化。
如果一个 key 不是 <code>PyStringObject</code> 类型，那么<code>ma_lookup</code> 将改为一种更慢的普通查找函数。</p> <h3 id="ma-smalltable"><a href="#ma-smalltable" aria-hidden="true" class="header-anchor">#</a> <strong>ma_smalltable</strong></h3> <p>一个有 8 个槽的哈希表（译者注：这里应该是最小 8 个槽，因为 <code>PyDict_MINSIZE=8</code>）。
这样小字典也能直接存储在这里，并且不会再调用 <code>malloc()</code>。</p> <h2 id="碰撞"><a href="#碰撞" aria-hidden="true" class="header-anchor">#</a> 碰撞</h2> <p>两个不同的 key 可能会被散列到相同的槽，这被称之为碰撞。当碰撞发生时，Python 使用 <em>开放寻址法</em> 来解决碰撞：如果这个槽不能再容纳这个 key（译者注：指槽中已经有 key），那么就寻找其他槽。</p> <p>例如，这里有个简单的方法，如果槽 <code>i</code> 不能再容纳这个 key，就尝试槽 <code>i+1</code> 、<code>i+2</code> 等等。对于每条哈希，我们现在定义了能容纳它的所有槽的列表，如果删除其中一个 key，整个列表将会被破坏，这就是这里为什么我们需要虚拟元素（dummy）。</p> <p>这个简单的开放寻址线性算法会使其退化为线性堆，这将导致性能降低，因为我们每次查找一个 key 都要扫描所有的槽。在实际中，CPython 使用如下算法：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>DUMMY <span class="token operator">=</span> <span class="token string">'dummy'</span>

<span class="token comment"># 以我的水平并不足够理解算法是如何工作的，</span>
<span class="token comment"># 最后的结果会覆盖 0 到 ma_mask 之间的所有整数。</span>
<span class="token keyword">def</span> <span class="token function">open_addressing_in_cpython</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token builtin">hash</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    free_slot <span class="token operator">=</span> <span class="token boolean">None</span>
    perturb <span class="token operator">=</span> <span class="token builtin">hash</span>
    i <span class="token operator">=</span> slot_index <span class="token operator">=</span> <span class="token builtin">hash</span> <span class="token operator">&amp;</span> ma_mask
    <span class="token keyword">while</span> table<span class="token punctuation">[</span>slot_index<span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> table<span class="token punctuation">[</span>slot_index<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">!=</span> key<span class="token punctuation">:</span>
        <span class="token keyword">if</span> table<span class="token punctuation">[</span>slot_index<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token keyword">is</span> DUMMY <span class="token keyword">and</span> free_slot <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            free_slot <span class="token operator">=</span> slot_index
        i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> i <span class="token operator">+</span> perturb <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        slot_index <span class="token operator">=</span> i <span class="token operator">&amp;</span> ma_mask
        perturb <span class="token operator">&gt;&gt;</span><span class="token operator">=</span> <span class="token number">5</span>
    <span class="token keyword">if</span> table<span class="token punctuation">[</span>slot_index<span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">and</span> free_slot <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> free_slot
    <span class="token keyword">return</span> slot_index
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="哈希表大小"><a href="#哈希表大小" aria-hidden="true" class="header-anchor">#</a> 哈希表大小</h2> <p>如果我们持续添加 key 到字典中，那很快就会没有足够的空间来装下所有的 keys，现在就需要对哈希表扩容（resize）。</p> <p>CPython 会在每次添加 key 时检查表大小，如果哈希表已经处于三分之二满（相对于 <code>ma_fill</code>），将扩容哈希表。如果字典中包含接近或超过 50000 keys，扩容后新的大小将为 <code>ma_used * 4</code>，其他时候扩容后为 <code>ma_used * 2</code>。</p> <p>哈希表不会在从字典中删除大量 keys 时引发调整大小，这意味着哈希表将不会变小。这不是什么大问题，因为大多数时候我们我们只使用字典一段时间，然后就丢弃掉整个字典。如果你真的建立了一个非常大的字典，并且从中删除了许多 keys，那么你应该用剩余的 key 创建一个新的字典。</p> <h2 id="空闲列表"><a href="#空闲列表" aria-hidden="true" class="header-anchor">#</a> 空闲列表</h2> <p>许多字典实例被频繁的创建和销毁，为了减少创建和销毁的次数，一种 <code>free_dicts</code> 数组被用于容纳不再使用的字典对象，相当于一个简单的缓存。如果我们需要一个 <code>PyDictObject</code> 对象，它将从可用的空闲列表中获取。</p> <h2 id="键共享与有序字典"><a href="#键共享与有序字典" aria-hidden="true" class="header-anchor">#</a> 键共享与有序字典</h2> <p>当字典用作对象属性的容器时，它们会占用比必要更多的内存，因为键是相同的，但它们却被复制到每个实例中了。自 Python 3.6 起，一个属性字典与同一类实例的其他属性字典共用 keys，例如有如下这样的类：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> username<span class="token punctuation">,</span> email<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>username <span class="token operator">=</span> username
        self<span class="token punctuation">.</span>email <span class="token operator">=</span> email
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这些属性字典将会被像这样存储：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># 这是在属性字典之间共享的</span>
<span class="token comment"># 并且这也是排序的</span>
keys <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token number">5317300778844242624</span><span class="token punctuation">,</span> <span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">268341141884068675</span><span class="token punctuation">,</span> <span class="token string">'email'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
<span class="token comment"># this hash table just stores the index to the key entries</span>
<span class="token comment"># 这个哈希表仅把索引存储到键元素中</span>
<span class="token comment"># 这是简化的</span>
index_table <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>

<span class="token comment"># 这是值</span>
values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'user01'</span><span class="token punctuation">,</span> <span class="token string">'user01@example.com'</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="我的想法"><a href="#我的想法" aria-hidden="true" class="header-anchor">#</a> 我的想法</h2> <p>CPython 中字典的实现过程是非常简洁明了和易懂的。它的代码优美而高效，所有的参数选择都是经过实践的，例如，其中 <code>free_dicts</code> 和 <code>ma_smalltable</code> 参数的大小。我爱它们。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/zthxxx/zthxxx.github.io/edit/master/source/_posts/2017-03-26--python-dictionary-implementation.md" target="_blank" rel="noopener noreferrer">Edit on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2/8/2019, 2:53:00 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.2e0dc0ff.js" defer></script><script src="/assets/js/1.b11822ca.js" defer></script><script src="/assets/js/21.93fd3aea.js" defer></script>
  </body>
</html>
